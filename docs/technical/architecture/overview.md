# Архитектура: Общая Картина

## Что Делает Система

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         KDP NICHE FINDER                                │
│                                                                         │
│   Пользователь вводит запрос → Система анализирует → Niche Score       │
│                                                                         │
│   "gratitude journal" → BSR + Keywords + Formula → 72/100 ХОРОШО       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Компоненты Системы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              FRONTEND                                   │
│                                                                         │
│   Next.js 14 + React + TailwindCSS + shadcn/ui                         │
│   ─────────────────────────────────────────────                        │
│   • Landing page (/)                                                    │
│   • Dashboard (/dashboard)                                              │
│   • Поиск ниш (/search)                                                │
│   • Сохранённые (/saved)                                               │
│   • Настройки (/settings)                                              │
│                                                                         │
│   Хостинг: Vercel (бесплатно)                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTPS
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              BACKEND                                    │
│                                                                         │
│   Next.js API Routes (Serverless Functions)                            │
│   ─────────────────────────────────────────                            │
│   • /api/auth/* → Авторизация                                          │
│   • /api/search → Поиск ниш                                            │
│   • /api/saved → Сохранённые ниши                                      │
│   • /api/usage → Статистика                                            │
│   • /api/webhooks/stripe → Платежи                                     │
│                                                                         │
│   Хостинг: Vercel (бесплатно, timeout 10 сек)                          │
└─────────────────────────────────────────────────────────────────────────┘
          │              │              │              │
          │              │              │              │
          ▼              ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   SUPABASE   │ │    KEEPA     │ │  KEYWORDS    │ │   STRIPE     │
│              │ │     API      │ │  EVERYWHERE  │ │              │
│ ──────────── │ │ ──────────── │ │ ──────────── │ │ ──────────── │
│ • Auth       │ │ • BSR данные │ │ • Search     │ │ • Подписки   │
│ • PostgreSQL │ │ • Цены       │ │   volume     │ │ • Платежи    │
│ • Cache      │ │ • Отзывы     │ │ • Тренды     │ │ • Webhooks   │
│              │ │ • История    │ │              │ │              │
│ Бесплатно    │ │ €19/мес      │ │ $21/год      │ │ ~5%          │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
```

---

## Как Компоненты Связаны

### 1. Авторизация

```
Пользователь → [Login Form] → Supabase Auth → JWT Token → Все запросы
```

### 2. Поиск Ниши

```
Запрос "gratitude journal"
    │
    ▼
[API /api/search]
    │
    ├──▶ [Cache] ──▶ Есть? ──▶ Вернуть (0 токенов)
    │                  │
    │                  ▼ Нет
    │         ┌────────┴────────┐
    │         ▼                 ▼
    │    [Keepa API]      [Keywords API]
    │         │                 │
    │         ▼                 ▼
    │    BSR, цены,        Search volume
    │    отзывы            50,000/мес
    │         │                 │
    │         └────────┬────────┘
    │                  ▼
    │         [Calculate Niche Score]
    │                  │
    │                  ▼
    │         [Save to Cache]
    │                  │
    └──────────────────┴──────▶ Response: { nicheScore: 72 }
```

### 3. Оплата

```
[Upgrade Button] → Stripe Checkout → Оплата → Webhook → plan = 'pro'
```

---

## Стек Технологий

| Слой | Технология | Почему |
|------|------------|--------|
| **Frontend** | Next.js 14 | SSR, бесплатный Vercel, всё в одном |
| **Стили** | TailwindCSS + shadcn/ui | Быстро, красиво, бесплатно |
| **Backend** | Next.js API Routes | Serverless, не нужен отдельный сервер |
| **База данных** | Supabase (PostgreSQL) | Бесплатно, Auth из коробки |
| **Кэш** | Supabase (таблица cache) | Уже есть, не нужен Redis |
| **BSR данные** | Keepa API | Легальный, дешёвый, надёжный |
| **Keywords** | Keywords Everywhere | Дешёвый, простой API |
| **Платежи** | Stripe | Стандарт индустрии |
| **Хостинг** | Vercel | Бесплатно для Next.js |
| **Cron** | GitHub Actions | Бесплатно, ping Supabase |

---

## Ключевые Решения

### Почему Serverless?

```
Традиционный сервер ($5-20/мес):
├── Нужно настраивать
├── Нужно масштабировать
├── Платишь даже когда никто не использует
└── DevOps головная боль

Serverless (Vercel, бесплатно):
├── Zero configuration
├── Автоматическое масштабирование
├── Платишь за использование (free tier = 0)
└── Фокус на коде, не на инфраструктуре
```

### Почему Кэш в Supabase, а не Redis?

```
Redis ($5-15/мес):
├── Быстрее (1ms vs 10ms)
├── Но нужен отдельный сервис
└── Дополнительные расходы

Supabase таблица cache (бесплатно):
├── Медленнее, но достаточно (10-50ms)
├── Уже есть в проекте
├── $0 дополнительно
└── Проще архитектура
```

### Почему 2 API вместо одного?

```
Keepa:
├── BSR (Best Seller Rank)
├── Цены
├── Отзывы
├── История продаж
└── НЕТ search volume

Keywords Everywhere:
├── Search volume (сколько ищут)
├── Тренды
└── НЕТ BSR данных

Вместе = полная картина ниши
```

---

## Ограничения и Решения

| Ограничение | Проблема | Решение |
|-------------|----------|---------|
| Vercel timeout 10 сек | Keepa может отвечать дольше | Кэширование |
| Supabase пауза 7 дней | Проект "уснёт" | GitHub Actions ping |
| Keepa токены | Быстро заканчиваются | Кэш 80%+ hit rate |
| Free tier 500MB | БД переполнится | Очистка expired кэша |

---

## Масштабирование

### Текущая Архитектура Выдержит

| Метрика | Лимит Free Tier | Достаточно для |
|---------|-----------------|----------------|
| Vercel requests | 150K/мес | ~5,000 DAU |
| Supabase MAU | 50,000 | 50,000 users |
| Supabase storage | 500MB | ~1M cache entries |

### Когда Нужен Upgrade

```
Признаки:
├── > 100K requests/мес → Vercel Pro ($20/мес)
├── > 500MB БД → Supabase Pro ($25/мес)
├── > 50K MAU → Supabase Pro
└── Cache hit rate < 50% → Больше Keepa токенов

При MRR $500+ можно позволить upgrade
```

---

## Безопасность

| Угроза | Защита |
|--------|--------|
| SQL Injection | Supabase prepared statements |
| XSS | React auto-escaping |
| CSRF | SameSite cookies |
| Данные пользователей | Supabase RLS (Row Level Security) |
| API ключи | Environment variables |
| DDoS | Vercel Edge Network |

---

## Файлы в Этой Папке

| Файл | Описание |
|------|----------|
| [overview.md](overview.md) | Этот документ — общая архитектура |
| [user-journey.md](user-journey.md) | Путь пользователя от регистрации до оплаты |
| [data-flow.md](data-flow.md) | Как данные текут через систему |
